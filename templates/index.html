<head>
<link rel="stylesheet" href={{ url_for('static', filename='style.css') }}>
<script src={{ url_for('static', filename='nanobar.min.js') }}></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

</head>
<body>

<button id="add_bar" onClick="create_bar()" style="margin-bottom: 10px;">Create Bar</button><br>

<script>

	var nanobars = {};

    var socket = io();
    socket.on('connect', function() {
        console.log("Websocket connected.");
    });

	function create_bar() {
		socket.emit('create_bar');
	}

	function render_bars(bars) {

		for (const [bar, values] of Object.entries(bars)) {

			// Create bar if not exists
			if (document.getElementById("b-" + bar) == null) {

				// Create div to put new bar in
				var div = document.createElement("div");
				div.setAttribute("id", "b-" + bar);
				document.body.appendChild(div);

				// Create paragraph for progress text
				var p = document.createElement("p");
				p.setAttribute("id", "p-" + bar);
				div.appendChild(p);

				// Create new bar, push to array
				var nanobar = new Nanobar({
					target: div,
					class: "bar",
					id: "nanobar-" + bar
				});
				nanobars[bar] = nanobar;
			}
			nanobars[bar].go(values['progress']);
			document.getElementById("p-" + bar).innerHTML = values['message'];
		}
	};
	
	// send ajax GET request every X seconds to retrieve progress bar updates
	// I wish the server would be able to push this data out, instead of the client asking for it every X seconds.
	function ajax_get() {
		$.ajax({
			type: 'GET',
			url: '/get_tasks',
			success: function(data, status, request) {
				render_bars(data);
			},
			error: function() {
				alert('Unexpected error');
			},
			complete: function(data) {
				setTimeout(ajax_get, 1000);
			}
		})
	};
	
	// Do initial 'get_tasks' GET request
	setTimeout(ajax_get, 1000);
</script>
	
</body>
</html>
