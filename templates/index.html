<head>
<link rel="stylesheet" href={{ url_for('static', filename='style.css') }}>
<script src={{ url_for('static', filename='nanobar.min.js') }}></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
    var socket = io();
    socket.on('connect', function() {
        console.log("Websocket connected.");
    });
</script>
</head>
<body>

<button id="add_bar" onClick="socketio_progress_bar()" style="margin-bottom: 10px;">Create Bar</button><br>

<script>

	var nanobars = {};

	function socketio_progress_bar() {
		socket.emit('socketio_progress_bar');
		console.log("button pressed");
	}

	socket.on('bars', function(bars) {
		console.log(bars);
		var i;
		for (i = 0; i < bars.length; i++) {
			
			var bar_id = bars[i]['id'];

			// Create bar if not exists
			if (typeof nanobars[bar_id] === 'undefined') {

				// Create div to put new bar in
				var div = document.createElement("div");
				div.setAttribute("id", "b-" + bar_id);
				document.body.appendChild(div);

				// Create paragraph for progress text
				var p = document.createElement("p");
				p.setAttribute("id", "p-" + bar_id);
				div.appendChild(p);

				// Create new bar, push to array
				var bar = new Nanobar({
					target: div,
					class: "bar",
					id: "nanobar-" + bar_id
				});
				nanobars[bar_id] = bar;
				console.log(nanobars);
			}

			nanobars[bar_id].go(bars[i]['progress']);
			document.getElementById("p-" + bar_id).innerHTML = bars[i]['message'];

		}
	});

	function add_bar() {
		// Create div to put new bar in
		var div = document.createElement("div");
		div.setAttribute("id", "bar-" + nanobars.length);
		document.body.appendChild(div);

		// Create paragraph for progress text
		var p = document.createElement("p");
		p.setAttribute("id", "p-" + nanobars.length);
		div.appendChild(p);

		// Create new bar, push to array
		var bar = new Nanobar({
			target: div,
			class: "bar",
			id: "nanobar-" + nanobars.length
		});
		nanobars.push(bar);
	}

	function progress_bar() {
		// Go through bars, update progress
		var i;
		for (i = 0; i < nanobars.length; i++) {
			var progress = Number(document.getElementById("p-" + i).textContent.replace("%", ""));
			
			progress = progress + 20;
			nanobars[i].go(progress);
			
			if (progress === 100) {
				document.getElementById("p-" + i).innerHTML = "Done!";
				document.getElementById("nanobar-" + i).firstChild.style.background = "lime";
				add_bar();
			} else if (progress < 100) {
				document.getElementById("p-" + i).innerHTML = progress + "%";
			}
		}
	}
</script>
	
</body>
</html>
