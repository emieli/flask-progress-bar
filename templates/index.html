<head>

<!-- We need jquery for the $('') javascript things to work, retrieve field data etc -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>

<!-- bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

</head>
<body>

<div class="container">
	<form id="create_host">
		<div class="form-group">
			<label for="hostname">Hostname</label>
			<input type="text" id="hostname" value="test" class="form-control col-3"> 
		</div>
		<input type="submit" id="submit" value="Submit" class="btn btn-primary">
	</form>

<script>

    var socket = io();
    socket.on('connect', function() {
        console.log("Websocket connected.");
    });

	$('#create_host').submit(function() {
		socket.emit('create_host', { hostname: $('#hostname').val() });
		return false;
	});

	var tasks = {};
	socket.on('new_task', function(task_id) {
		tasks[task_id] = task_id;
		get_task_updates();
	});

	function get_task_updates() {
		socket.emit('get_task_updates', tasks);
	}

	socket.on('task_updates', function(bars) {

		tasks = bars;
		for (const [task, values] of Object.entries(bars)) {

			if (document.getElementById(task) == null) {
				// Progress div
				var progress = document.createElement("div");
				progress.setAttribute("class", "progress mb-3");
				progress.setAttribute("style", "height: 25px;");
				document.body.appendChild(progress);

				// Progress bar div
				var progress_bar = document.createElement("div");
				progress_bar.setAttribute("id", task);
				progress_bar.setAttribute("class", "progress-bar progress-bar-striped progress-bar-animated");
				progress.appendChild(progress_bar);
			}
			
			if (values['status'] === "finished") {
				document.getElementById(task).innerHTML = values['meta']['message'];
				document.getElementById(task).className = "progress-bar bg-success w-100";
				delete tasks[task];
			}
			else if (values['status'] === "failed") {
				document.getElementById(task).innerHTML = values['meta']['message'];
				document.getElementById(task).className = "progress-bar bg-danger w-100";
				delete tasks[task];
			}
			else if (values['status'] === "queued") {
				document.getElementById(task).innerHTML = "pending";
				document.getElementById(task).className = "progress-bar bg-secondary w-5";
			}
			else if (values['status'] === "started") {
				document.getElementById(task).className = "progress-bar progress-bar-striped progress-bar-animated w-" + values['meta']['progress'];
				document.getElementById(task).innerHTML = values['meta']['message'];
			}
		}
		// Trigger new task update request
		setTimeout(get_task_updates, 100);
	});
	
</script>

</div>

</body>
</html>
